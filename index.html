<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>U.S. Deadliest Mass Shootings</title>
    <script src="./d3.js"></script>
    <script src="./tooltipEffect.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <svg></svg>

    <!-- <div class='tooltipContainer hidden'>
      <div class='tooltipDateLabel'></div>
      <div class='tooltipLocation'></div>
      <div class='tooltipLink'></div>
    </div> -->

    <script>
      let rowConverter = d => {
        return {
          id: d.id,
          date: d.date,
          location: d.location,
          name: d.name,
          fatalities: Number(d.fatalities)
        }
      };

      let dataset;

      d3.csv("us-mass-shootings-data.csv", rowConverter, data => {
        dataset = data;
        loadDataVis();
      });

      function loadDataVis() {
        let w = 800, h = 650;
        let margin = {top: 30, bottom: 30, left: 20, right: 20}

        let colors = d3.scaleLinear()
                       .domain([
                         d3.min(dataset, d => d.fatalities),
                         d3.max(dataset, d => d.fatalities)
                       ])
                       .range(["brown", "red"]);

        let svg = d3.select("svg")
                    .attr("width", w)
                    .attr("height", h);

        svg.append("text")
           .attr("x", w/2)
           .attr("y", margin.top + 10)
           .attr("text-anchor", "middle")
           .attr("font-size", 30)
           .attr("font-family", "'Noto Sans', sans-serif")
           .attr("text-decoration", "underline")
           .text("Mass Shootings in the U.S. and their Fatalities");

        let pack = d3.pack()
                     .size([w, h - margin.bottom])
                     .padding(1.5);

        let root = d3.hierarchy({children: dataset})
                     .sum(d => d.fatalities)
                     .each(d => d.id = d.data.id);

        let packedData = pack(root).leaves();

        let fontSizeScale = d3.scaleLinear()
                              .domain([
                                 d3.max(packedData, d => d.data.name.length/d.r),
                                 d3.min(packedData, d => d.data.name.length/d.r)
                               ])
                              .range([10, 18]);

        let node = svg.selectAll(".node")
                      .data(packedData)
                      .enter().append("g")
                      .attr("class", "node")
                      .attr("transform", d => "translate(" + d.x + "," + (d.y + margin.top) + ")")
                      .call(tooltipEffect);

        let highlightEffect = circle => {
          circle.on("mouseover", function() {
                  this.style.fill = "black";
                })
                .on("mouseout", function(d, i) {
                  this.style.fill = colors(d.data.fatalities);
                });
        }

        function getCoords(elem) { // crossbrowser version
            var box = elem.getBoundingClientRect();

            var body = document.body;
            var docEl = document.documentElement;

            var scrollTop = window.pageYOffset || docEl.scrollTop || body.scrollTop;
            var scrollLeft = window.pageXOffset || docEl.scrollLeft || body.scrollLeft;

            var clientTop = docEl.clientTop || body.clientTop || 0;
            var clientLeft = docEl.clientLeft || body.clientLeft || 0;

            var top  = box.top +  scrollTop - clientTop;
            var left = box.left + scrollLeft - clientLeft;

            return { top: Math.round(top), left: Math.round(left) };
        }

        node.append("circle")
            .attr("id", d => d.id)
            .attr("r", d => d.r)
            .style("fill", (d, i) => colors(d.data.fatalities))
            .call(highlightEffect);

        node.append("clipPath")
            .attr("id", d => "clip-" + d.id)
            .append("use")
            .attr("xlink:href", d => "#" + d.id);

        //insert names of shootings
        node.append("text")
            .attr("clip-path", d => "url(#clip-" + d.id + ")")
            .text(d => d.data.name)
            .attr("class", "labels")
            .attr("text-anchor", "middle")
            .style("font-size", d => fontSizeScale(d.data.name.length/d.r));

        //insert fatalities of shootings
        node.append("text")
            .attr("clip-path", d => "url(#clip-" + d.id + ")")
            .text(d => {
              if (d.data.name == "Las Vegas") return "â‰¥ " + d.data.fatalities;
              return d.data.fatalities;
            })
            .attr("y", 20)
            .attr("class", "labels")
            .attr("text-anchor", "middle");

      }

    </script>
  </body>
</html>
